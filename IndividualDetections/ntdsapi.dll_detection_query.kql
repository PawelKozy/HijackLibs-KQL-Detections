DeviceImageLoadEvents
| extend FileName = tolower(FileName), FolderPath = tolower(FolderPath), InitiatingProcessFileName = tolower(InitiatingProcessFileName)
| where Filename == "ntdsapi.dll"
| where not(FolderPath contains "c:\\windows\\system32" or FolderPath contains "c:\\windows\\syswow64") and (InitiatingProcessFileName endswith "certutil.exe" or InitiatingProcessFileName endswith "cipher.exe" or InitiatingProcessFileName endswith "dcdiag.exe" or InitiatingProcessFileName endswith "dfsrdiag.exe" or InitiatingProcessFileName endswith "dnscmd.exe" or InitiatingProcessFileName endswith "dsacls.exe" or InitiatingProcessFileName endswith "dsadd.exe" or InitiatingProcessFileName endswith "dsdbutil.exe" or InitiatingProcessFileName endswith "dsget.exe" or InitiatingProcessFileName endswith "dsmgmt.exe" or InitiatingProcessFileName endswith "dsquery.exe" or InitiatingProcessFileName endswith "gpresult.exe" or InitiatingProcessFileName endswith "licmgr.exe" or InitiatingProcessFileName endswith "netdom.exe" or InitiatingProcessFileName endswith "nltest.exe" or InitiatingProcessFileName endswith "ntdsutil.exe" or InitiatingProcessFileName endswith "rendom.exe" or InitiatingProcessFileName endswith "repadmin.exe" or InitiatingProcessFileName endswith "setspn.exe" or InitiatingProcessFileName endswith "w32tm.exe")
| invoke FileProfile("SHA1", 1000)
